<!DOCTYPE html>
<html lang="en">
	<head>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=yes">
	
		
	</head>
	<body>
		<div id="container" style="max-width: 800px; pointer-events: all;">
			<video id="video" style="width: 100%;"  loop crossOrigin="anonymous" controls playsinline>
				<source src="https://videos.electroteque.org/bitrate/big_buck_bunny_2000k.mp4">
			</video>
            <canvas id="renderer" style="background: #000000; width: 100%; height: 100%"></canvas>
		</div>
        
		<script type="importmap">
			{
				"imports": {
					"canvas-pip-fullscreen": "../build/canvas-pip-fullscreen.module.js",
                    "fullscreen-api": "../build/fullscreen-api.module.js",
                    "screenlock-api": "../build/screenlock-api.module.js"
				}
			}
		</script>


		<script type="module">

			import {
				CanvasPipFullscreen,
                CanvasPipFullscreenUtil
			} from 'canvas-pip-fullscreen';

            import FullscreenApi from 'fullscreen-api';
            import ScreenLockApi from 'screenlock-api';

            const video = document.getElementById( 'video' ),
            canvas = document.getElementById( 'renderer' ),
            container = document.getElementById( 'container' );

            if (!ScreenLockApi.supportsScreenLock) ScreenLockApi.lockElement(container);

            

            container.addEventListener("click", function onClick() {
                video.load();
                video.play();

    
                container.removeEventListener("click", onClick);
            });

            const canvasPipFullscreen = new CanvasPipFullscreen(canvas, video);

            const fullScreenAvailable = CanvasPipFullscreenUtil.fullScreenAvailable;
            

            if (CanvasPipFullscreenUtil.pipSupported) {
                canvasPipFullscreen.initPip();

                const pipButton = document.createElement("button");
                pipButton.innerText = "Enter Pip";

                canvasPipFullscreen.on("enterpictureinpicture", () => {
                    pipButton.innerText = "Exit Pip";
                }).on("leavepictureinpicture", () => {
                    pipButton.innerText = "Enter Pip";
                }).on("failed", (e, isCanvas, error) => {
                    console.log("Picture in picture error ", error);
                }).on("disabled", (e, isCanvas, disabled) => {
                    console.log("PIP Disabled", disabled);
                    pipButton.disabled = disabled;
                });

                pipButton.addEventListener("click", () => {
                    canvasPipFullscreen.togglePictureInPicture(true);
                });

                document.body.appendChild(pipButton);

            }

            const fsButton = document.createElement("button");
            fsButton.innerText = "Enter Fullscreen";

            container.appendChild(fsButton);

            

            if (fullScreenAvailable) {
                fsButton.addEventListener("click", () => {
                    //html fullscreen
                    FullscreenApi.requestFullscreen(container);
                });

                
                const onFsChange = () => {
                    if (FullscreenApi.currentFullScreenElement) {
                        ScreenLockApi.lock("landscape").then(() => {}).catch(() => {});
                        fsButton.innerText = "Exit Fullscreen";
                    } else {
                        ScreenLockApi.unlock();
                        fsButton.innerText = "Enter Fullscreen";
                    }
                };

                document.addEventListener("fullscreenchange", onFsChange);
                document.addEventListener("webkitfullscreenchange", onFsChange);

            } else if (!fullScreenAvailable && CanvasPipFullscreenUtil.isIOS) {
                //init canvas fullscreen manager for iPhone
                canvasPipFullscreen.initFullscreen();

                canvasPipFullscreen.on('webkitbeginfullscreen', () => {
                    console.log("canvas video fullscreen");
                    ScreenLockApi.lock("landscape").then(() => {}).catch(() => {});
                }).on('webkitendfullscreen', () => {
                    console.log("canvas video exit fullscreen");
                    ScreenLockApi.unlock();
                });

                fsButton.addEventListener("click", () => {
                    //canvas video capture fullscreen
                    canvasPipFullscreen.requestFullscreen(container);
                });

                container.insertBefore(canvasPipFullscreen.canvasVideo, container.firstChild);
            }
            
            

        </script>
    
	</body>
</html>
